{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {

    "environmentTag": { "type": "string" },
    "parentBusinessTag": { "type": "string" },
    "portfolioTag": { "type": "string" },
    "productTag": { "type": "string" },
    "serviceTag": {
      "type": "string",
      "defaultValue": "[parameters('productTag')]"
    },
    "serviceLineTag": { "type": "string" },
    "serviceOfferingTag": {
      "type": "string",
      "defaultValue": "[parameters('productTag')]"
    },

    "storageAccountName": { "type": "string" },
    "storageAccountLocation": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },

    "accountType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS", "Standard_GRS", "Standard_RAGRS", "Premium_LRS"
      ]
    },

    "accessTier": {
      "type": "string",
      "defaultValue": "",
      "allowedValues": [ "Hot", "Cool", "" ]
    },

    "storageKind": {
      "type": "string",
      "defaultValue": "Storage",
      "allowedValues": [ "Storage", "StorageV2", "BlobStorage" ]
    },

    "subnetResourceIdList": {
      "type": "array",
      "defaultValue": []
    },

    "allowedIpAddressesList": {
      "type": "array",
      "defaultValue": []
    },

    "enableCors": {
      "type": "string",
      "defaultValue": "False",
      "allowedValues": [ "False", "True" ]
    },

    "allowedHeaders": { "type": "array", "defaultValue": [ "*" ] },
    "allowedOrigins": { "type": "array", "defaultValue": [ "*" ] },
    "maxAgeInSeconds": { "type": "string", "defaultValue": "3600" },
    "allowedMethods": { "type": "array", "defaultValue": [ "GET" ] },
    "exposedHeaders": { "type": "array", "defaultValue": [ "*" ] },

    "minimumTlsVersion": {
      "type": "string",
      "defaultValue": "TLS1_0",
      "allowedValues": [ "TLS1_0", "TLS1_2", "TLS1_3" ]
    },

    "allowBlobPublicAccess": {
      "type": "bool",
      "defaultValue": true
    },

    "settingName": {
      "type": "String",
      "defaultvalue": "StorageAccDiagSettings"
    },

    "workspaceId": { "type": "String", "defaultValue": "" },
    "TransactionSetting": { "type": "bool", "defaultvalue": false },
    "BlobTransactionSetting": { "type": "bool", "defaultvalue": false },
    "BlobStorageReadSetting": { "type": "bool", "defaultvalue": false },
    "BlobStorageWriteSetting": { "type": "bool", "defaultvalue": false },
    "BlobStorageDeleteSetting": { "type": "bool", "defaultvalue": false },

    "retentionPolicyEnabled": { "type": "bool", "defaultValue": true },
    "retentionPolicyDays": { "type": "string", "defaultValue": "30" },
    "publicNetworkAccess": {
      "type": "string",
      "defaultValue": "Enabled",
      "allowedValues": [ "Enabled", "Disabled" ]
    },
    "networkAclsObject": {
      "type": "object",
      "defaultValue": {}
    }
  },

  "variables": {
    "virtualNetworkRules": {
      "copy": [
        {
          "name": "virtualNetworkRules",
          "count": "[if(greater(length(parameters('subnetResourceIdList')), 0), length(parameters('subnetResourceIdList')), 1)]",
          "input": {
            "id": "[if(greater(length(parameters('subnetResourceIdList')), 0), parameters('subnetResourceIdList')[copyIndex('virtualNetworkRules')], json('null'))]",
            "action": "Allow"
          }
        }
      ]
    },

    "ipRules": {
      "copy": [
        {
          "name": "ipRules",
          "count": "[if(greater(length(parameters('allowedIpAddressesList')), 0), length(parameters('allowedIpAddressesList')), 1)]",
          "input": {
            "value": "[if(greater(length(parameters('allowedIpAddressesList')), 0), parameters('allowedIpAddressesList')[copyIndex('ipRules')], json('null'))]",
            "action": "Allow"
          }
        }
      ]
    }
  },

  "resources": [
    {
      "apiVersion": "2019-04-01",
      "name": "[parameters('storageAccountName')]",
      "type": "Microsoft.Storage/storageAccounts",
      "location": "[parameters('storageAccountLocation')]",
      "sku": { "name": "[parameters('accountType')]" },
      "kind": "[parameters('storageKind')]",
      "tags": {
        "Environment": "[parameters('environmentTag')]",
        "Parent Business": "[parameters('parentBusinessTag')]",
        "Portfolio": "[parameters('portfolioTag')]",
        "Product": "[parameters('productTag')]",
        "Service": "[parameters('serviceTag')]",
        "Service Line": "[parameters('serviceLineTag')]",
        "Service Offering": "[parameters('serviceOfferingTag')]"
      },
      "properties": {
        "encryption": {
          "services": { "blob": { "enabled": true }, "file": { "enabled": true } },
          "keySource": "Microsoft.Storage"
        },

        "accessTier": "[if(empty(parameters('accessTier')), json('null'), parameters('accessTier'))]",
        "allowBlobPublicAccess": "[parameters('allowBlobPublicAccess')]",
        "supportsHttpsTrafficOnly": true,
        "minimumTlsVersion": "[parameters('minimumTlsVersion')]",
        "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
        "networkAcls": "[parameters('networkAclsObject')]"
      }
    }
  ],

  "outputs": {
    "storageKey": {
      "type": "string",
      "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts',parameters('storageAccountName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value]"
    },
    "storageConnectionString": {
      "type": "string",
      "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('storageAccountName'),';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts',parameters('storageAccountName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value, ';EndpointSuffix=core.windows.net')]"
    },
    "storagePrimaryEndpointsBlob": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Storage/storageAccounts',parameters('storageAccountName')), '2019-04-01').primaryEndpoints.blob]"
    }
  }
}
